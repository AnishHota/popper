#!/bin/bash
set -ex

function init_test {
  cd
  rm -rf /tmp/mypaper
  mkdir /tmp/mypaper
  cd /tmp/mypaper
  git init
  popper init
}

init_test
test -f .popper.yml

# default values
popper init pipeone
cat .popper.yml | grep '\- host'
cat .popper.yml | grep 'path: pipelines/pipeone'
test -f pipelines/pipeone/setup.sh
test -f pipelines/pipeone/run.sh
test -f pipelines/pipeone/post-run.sh
test -f pipelines/pipeone/validate.sh
test -f pipelines/pipeone/teardown.sh

# arbitrary stages and envs
init_test
popper init --stages=one,two,three --envs=host,ubuntu-xenial pipetwo
cat .popper.yml | grep '\- host'
cat .popper.yml | grep '\- ubuntu-xenial'
cat .popper.yml | grep '\- one'
cat .popper.yml | grep '\- two'
cat .popper.yml | grep '\- three'
test -f pipelines/pipetwo/one.sh
test -f pipelines/pipetwo/two.sh
test -f pipelines/pipetwo/three.sh

# existing pipeline
init_test
mkdir ci
echo '' > ci/one.sh
echo '' > ci/two
echo '' > ci/three
popper init --existing --stages=one,two,three ci
cat .popper.yml | grep '\- host'
cat .popper.yml | grep '\- one'
cat .popper.yml | grep '\- two'
cat .popper.yml | grep '\- three'
cat .popper.yml | grep 'path: ci'

popper ci travis
test -f .travis.yml

popper ci circleci
test -f .circleci/config.yml

popper ci jenkins
test -f Jenkinsfile

popper workflow pipeone > wf.dot
cat wf.dot | grep digraph
cat wf.dot | grep setup
cat wf.dot | grep post-run
cat wf.dot | grep validate
cat wf.dot | grep teardown

cd pipelines/pipeone

popper run
test -f popper_logs/setup.sh.err
test -f popper_logs/setup.sh.out
test -f popper_logs/run.sh.out
test -f popper_logs/run.sh.out
test -f popper_logs/post-run.sh.out
test -f popper_logs/post-run.sh.out
test -f popper_logs/validate.sh.out
test -f popper_logs/validate.sh.out
test -f popper_logs/teardown.sh.out
test -f popper_logs/teardown.sh.out
test -f popper_status

# popper check without some stages
rm teardown.sh
rm post-run.sh
popper run
test -f popper_logs/setup.sh.err
test -f popper_logs/setup.sh.out
test -f popper_logs/run.sh.out
test -f popper_logs/run.sh.out
test -f popper_logs/validate.sh.out
test -f popper_logs/validate.sh.out

cd /tmp/mypaper

popper metadata | grep 'No metadata entries yet'

popper metadata set authors 'the ramones, sex pistols'
popper metadata get authors | grep 'the ramones'
popper metadata set authors 'the police' | grep 'already assigned'
popper metadata set year '1979'
popper metadata | grep "year: '1979'"
popper metadata | grep "authors: 'the ramones, sex pistols'"

popper init --env=ubuntu-16.04 mypipelineonubuntu
cat .popper.yml | grep 'mypipelineonubuntu: ubuntu-16.04'

# TODO: check arbitrary stages
